<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <canvas id="test" width="1200" height="600"></canvas>
  <script>
    const canvas = document.querySelector('#test');
    const ctx = canvas.getContext('2d');
    let keyDown = {};
    let objectList = [];
    let stage = 0;
    let 점프timer = 0;
    let 점프중 = false;
    // let isPotal = false;

    const image = new Image();
    image.src = './쪼렙마리오.png';

    const 벽돌 = new Image();
    벽돌.src = './벽돌.png';

    const 파이프 = new Image();
    파이프.src = './파이프.png';

    const 함정파이프 = new Image();
    함정파이프.src = './함정파이프.png';

    const 아이템벽돌 = new Image();
    아이템벽돌.src = './아이템벽돌.png';

    const 배경 = new Image();
    배경.src = './마리오배경.jpg';

    const 배경2 = new Image();
    배경2.src = './바다배경.jpg';

    let backX = 0;

    const 아이템버섯 = new Image();
    아이템버섯.src = './아이템버섯.png';

    addEventListener('keydown', (e) => {
      keyDown[e.keyCode] = true;
    })

    addEventListener('keyup', (e) => {
      keyDown[e.keyCode] = false;
    })

    class Player {
      constructor() {
        this.size = 50;
        this.x = 0;
        this.y = canvas.height - this.size;
        this.speed = 5;
        this.color = 'red';
      }

      movePlayer() {
        let px = this.x;
        let py = this.y;
        let isPotal = false;

        if (keyDown[37]) {
          this.x -= this.speed;
          // isPotal = false; 
        }
        if (keyDown[39]) {
          this.x += this.speed;
          // isPotal = false; 

        }
        if (keyDown[38]) {
          this.y -= this.speed;
          // isPotal = false; 
        }
        if (keyDown[40]) { // 아래로 이동
          this.y += this.speed;
          isPotal = true;
        }
        if (keyDown[32]) {
          // 스페이스바 눌렀을 때
          점프중 = true;
        }

        if (점프중 == true) {
          this.y -= 2;
          점프timer++;
        }
        if (점프중 == false) {
          if (this.y < canvas.height - this.size) {
            this.y += 2;
          }
        }
        if (점프timer > 100) {
          점프중 = false;
          점프timer = 0;
        }
        let maxX = canvas.width - this.size;
        let maxY = canvas.height - this.size;
        if (this.x <= 0) this.x = 0;
        if (this.x >= maxX) this.x = maxX;
        if (this.y <= 0) this.y = 0;
        if (this.y >= maxY) this.y = maxY;


        let isCrash = false;
        let goNext = false;
        let isItemBlock = false;
        let isTrap = false;

        objectList.forEach((obj) => {
          if (this.collision(obj)) {
            if (obj.name === '파이프') {
              if (isPotal) {
                goNext = true;
                stage += 1;
              }
            }
            if (obj.name === "벽돌" || obj.name === "풀숲") {
              isCrash = true;
            }
            if (obj.name === "아이템벽돌") {
              isCrash = true;
              isItemBlock = true;
            }
            if (obj.name === "파이프" && obj.id === 1) {
              isTrap = true;
            }
            return false;
          }
        })
        if (isTrap) {
          objectList = objectList.filter(obj => obj.id !== 1);
          objectList.push(new Object('함정파이프', 5, canvas.width - 400, 400, 100, 200));
          setTimeout(() => {}, 500);
          this.x = 0;
          this.y = canvas.height - this.size;
        }
        if (isCrash) {
          this.x = px;
          // this.y = py;
          this.y = canvas.height - this.size;
        }
        if (isItemBlock) {
          setTimeout(() => {
            objectList = objectList.filter(obj => obj.name !== "아이템벽돌");
            objectList.push(new Object('아이템버섯', 0, 450, 330, 35, 35));
          }, 500);
        }
        if (goNext) {
          if (stage === 1) openNewStage();
          else if (stage === 2) openNewStage2();
        }
      }


      inRect(obj, px, py) {
        if (obj.x < px && px < obj.x + obj.width && obj.y < py && py < obj.y + obj.height) {
          return true;
        } else {
          false;
        }
      }

      collision(obj) {


        if (this.inRect(obj, this.x, this.y)) {
          return true;
        }
        // player의 오른쪽 상단 모서리가 닿으면
        else if (this.inRect(obj, this.x + this.size, this.y)) {
          return true;
        }
        // player의 왼쪽 하단 모서리가 닿으면
        else if (this.inRect(obj, this.x, this.y + this.size)) {
          // isPotal = true;
          return true;
        }
        // player의 오른쪽 하단 모서리가 닿으면
        else if (this.inRect(obj, this.x + this.size, this.y + this.size)) {
          return true;
        } else return false;
      }

      render(ctx) {
        this.movePlayer();
        ctx.beginPath();
        ctx.fillStyle = this.color;
        ctx.drawImage(image, this.x, this.y, this.size, this.size);
        // ctx.rect(this.x, this.y, this.size, this.size);
        ctx.fill();
      }
    }

    class Object {
      constructor(name, id, x, y, width, height, color) {
        this.name = name;
        this.id = id;
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.color = color;
      }

      render(ctx) { // 파이프용
        ctx.beginPath();
        // ctx.fillStyle = this.color;
        // ctx.rect(this.x, this.y, this.width, this.height);
        ctx.drawImage(파이프, this.x, this.y, this.width, this.height);
        ctx.fill();
      }

      renderBlock(ctx) { // 벽돌용
        ctx.beginPath();
        ctx.fillStyle = this.color;
        // ctx.rect(this.x, this.y, this.width, this.height);
        ctx.drawImage(벽돌, this.x, this.y, this.width, this.height);
        ctx.fill();
      }

      renderItemBlock(ctx) {
        ctx.drawImage(아이템벽돌, this.x, this.y, this.width, this.height);
      }

      renderItemMushroom(ctx) {
        ctx.drawImage(아이템버섯, this.x, this.y, this.width, this.height);
      }

      renderTrapPipe(ctx) {

      }
    }

    let player = new Player();

    function add() {
      objectList.push(new Object('벽돌', 0, 100, 400, 50, 50));
      objectList.push(new Object('벽돌', 0, 145, 400, 50, 50));
      objectList.push(new Object('벽돌', 0, 350, 350, 50, 50));
      objectList.push(new Object('벽돌', 0, 395, 350, 50, 50));
      objectList.push(new Object('아이템벽돌', 0, 445, 350, 50, 50));
      objectList.push(new Object('파이프', 1, canvas.width - 400, 400, 100, 200));
      objectList.push(new Object('파이프', 2, canvas.width - 100, 400, 100, 200));
      console.log(objectList);
      objectList.forEach((e) => {
        console.log(e.x);
      })
    }


    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      backX += 1;
      if (stage == 0) {
        ctx.drawImage(배경, backX, 0, canvas.width, canvas.height);
        ctx.drawImage(배경, backX - canvas.width, 0, canvas.width, canvas.height);
      } else if (stage == 1) {
        ctx.drawImage(배경2, backX, 0, canvas.width, canvas.height);
        ctx.drawImage(배경2, backX - canvas.width, 0, canvas.width, canvas.height);
      }
      if (backX == canvas.width) {
        backX = 0;
      }
      objectList.forEach((e) => {
        if (e.name == '파이프') {
          e.render(ctx)
        } else if (e.name == '벽돌') {
          e.renderBlock(ctx);
        } else if (e.name == '아이템벽돌') {
          e.renderItemBlock(ctx);
        } else if (e.name == '아이템버섯') {
          e.renderItemMushroom(ctx);
        }
      })
      player.render(ctx);
    }


    function openNewStage() {
      player.x = 0;
      player.y = canvas.height - player.size;
      objectList = [];
      objectList.push(new Object('벽돌', 0, canvas.width / 2, canvas.height / 2, 400, 200, 'green'));
      objectList.push(new Object('파이프', 2, canvas.width - 100, 400, 100, 150, 'pink'));
      console.log(objectList);
    }

    function openNewStage2() {
      player.x = 0;
      player.y = canvas.height - player.size;
      objectList = [];
      objectList.push(new Object('벽돌', 0, 300, canvas.height / 2, 400, 200, 'gray'));
      objectList.push(new Object('파이프', 2, canvas.width - 100, 400, 100, 150, 'pink'));
      console.log(objectList);
    }


    add();
    setInterval(draw, 10);
  </script>
</body>

</html>