<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    button {
      position: absolute;
      top: 300px;
      left: 600px;
      z-index: 10;
      padding: 40px 80px;
      font-size: 48px;
      border-radius: 5px;
      background-color: white;
      transform: translate(-50%, -50%);
      transition: background-color 0.5s;
    }

    button:hover {
      border: none;
      background-color: lightcoral;
      color: white;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <canvas id="test" width="1200" height="600"></canvas>
  <button> Game Start</button>

  <script>
    const startBtn = document.querySelector("button");
    const canvas = document.querySelector('#test');
    const ctx = canvas.getContext('2d');
    let keyDown = {};
    let objectList = [];
    let stage = 0;
    let 점프timer = 0;
    let 점프중 = false;
    // let isPotal = false;
    let 마리오커짐 = false; // true 면 커짐
    let isOver = false;

    const x3 = new Image();
    x3.src = './x3.png';
    const x2 = new Image();
    x2.src = './x2.png';
    const x1 = new Image();
    x1.src = './x1.png';

    const image = new Image();
    image.src = './쪼렙마리오.png';

    const bigMario = new Image();
    bigMario.src = './슈퍼마리오.png';

    const 벽돌 = new Image();
    벽돌.src = './벽돌.png';

    const 파이프 = new Image();
    파이프.src = './파이프.png';

    const 피라냐식물 = new Image();
    피라냐식물.src = './피라냐식물.png';

    const 아이템벽돌 = new Image();
    아이템벽돌.src = './아이템벽돌.png';

    const 배경 = new Image();
    배경.src = './마리오배경.jpg';

    const 배경2 = new Image();
    배경2.src = './바다배경.jpg';

    let backX = 0;

    const 아이템버섯 = new Image();
    아이템버섯.src = './아이템버섯.png';

    const oneUp = new Image();
    oneUp.src = './목숨1up.png';

    const 굼바 = new Image();
    굼바.src = './굼바.png';

    const 플라잉굼바 = new Image();
    플라잉굼바.src = './플라잉굼바.png';

    addEventListener('keydown', (e) => {
      keyDown[e.keyCode] = true;
    })

    addEventListener('keyup', (e) => {
      keyDown[e.keyCode] = false;
    })

    class Player {
      constructor() {
        this.size = 50;
        this.x = 0;
        this.y = canvas.height - this.size;
        this.speed = 5;
        this.color = 'red';
        this.life = 3;
      }

      movePlayer() {
        let px = this.x;
        let py = this.y;
        let isPotal = false;

        if (keyDown[37]) {
          this.x -= this.speed;
          // isPotal = false; 
        }
        if (keyDown[39]) {
          this.x += this.speed;
          // isPotal = false; 

        }
        if (keyDown[38]) {
          this.y -= this.speed;
          // isPotal = false; 
        }
        if (keyDown[40]) { // 아래로 이동
          this.y += this.speed;
          isPotal = true;
        }
        if (keyDown[32]) {
          // 스페이스바 눌렀을 때
          점프중 = true;
        }

        // document.addEventListener("keydown", e => {
        //   if (e.keycode === 'Space') {
        //     점프중 = true;
        //   }
        // })
        if (점프중 == true) {
          this.y -= 2;
          점프timer++;
        }
        let onBlock = false;
        let blockY;
        if (점프중 == false) {
          if (this.y < canvas.height - this.size) {
            // this.y += 2;
            objectList.filter((obj) => {
              if (obj.name === '벽돌' || obj.name === '아이템벽돌') {
                if (this.inBottom(obj, this.x, this.y)) {
                  onBlock = true;
                  blockY = obj.y;
                }
              }
            })
            if (onBlock) {
              this.y = blockY;
            } else {
              this.y += 2;
            }
          }
        }
        if (점프timer > 70) {
          점프중 = false;
          점프timer = 0;
        }
        let maxX = canvas.width - this.size;
        let maxY = canvas.height - this.size;
        if (this.x <= 0) this.x = 0;
        if (this.x >= maxX) this.x = maxX;
        if (this.y <= 0) this.y = 0;
        if (this.y >= maxY) this.y = maxY;


        let isCrash = false;
        let goNext = false;
        let isItemBlock = false;
        let isTrap = false;
        let killGumba = false;
        let isEatItem = false;
        let breakBlock = false;
        let findId;

        objectList.forEach((obj) => {
          if (this.collision(obj)) {
            if (obj.name === '파이프') {
              if (isPotal) {
                goNext = true;
                stage += 1;
              }
            }
            if (obj.name === "벽돌") {
              // isCrash = true;
            }
            if (obj.name === "아이템벽돌") {
              // isCrash = true;
              // isItemBlock = true;
            }
            if (obj.name === "파이프" && obj.id === '함정') {
              isTrap = true;
            }
            // if (obj.name === "굼바" || obj.name === "플라잉굼바") {
            //   isOver = true;
            // }
            if (obj.name === "아이템버섯") {
              // 마리오커짐 = true;
              // this.size += 30;
              isEatItem = true;
            }
            return false;
          }
        })
        objectList.forEach((enemy) => {
          if (enemy.name === '굼바') {
            if (this.inBottom(enemy, this.x, this.y)) {
              killGumba = true;
            }
          }
          if (this.isGumba(enemy)) {
            // isOver = true;
            if (마리오커짐) {
              마리오커짐 = false;
              this.size = 50;
            } else {
              this.life -= 1;
              isOver = true;
            }
            this.x = 0;
            // this.y = canvas.height - this.size;
            this.y = canvas.height - 100;

          }
          if (enemy.name === '벽돌' || enemy.name === '아이템벽돌') {
            if (this.heading(enemy, this.x, this.y) && !마리오커짐) {
              isCrash = true;
              if (enemy.name == '아이템벽돌') {
                isItemBlock = true;
              }
            } else if (this.heading(enemy, this.x, this.y) && 마리오커짐) {
              breakBlock = true;
              findId = enemy.id;
            }
            if (this.inBottom(enemy, this.x, this.y)) {
              // this.y = enemy.y - 50;
            }
          }
        })

        if (breakBlock) {
          objectList = objectList.filter(obj => obj.id !== findId);
        }

        if (isEatItem) {
          마리오커짐 = true;
          setTimeout(() => {
            this.size += 50;
            if (this.size >= 80) {
              this.size = 100;
            }
          }, 50);
          objectList = objectList.filter(obj => obj.name !== "아이템버섯");
          objectList.push(new Object('oneUp', 5, 600, 300, 100, 100));
          setTimeout(() => {
            objectList = objectList.filter(obj => obj.name !== "oneUp");
          }, 1000);
        }
        if (killGumba) {
          objectList = objectList.filter(obj => obj.name !== "굼바");
        }
        if (isOver) {
          clearInterval(monsterInterval);
          clearInterval(playGame);
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.beginPath();
          ctx.rect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = 'black';
          ctx.fill();
          if (this.life == 0) {
            startBtn.style.visibility = "visible";
            startBtn.innerHTML = "Game Over";
            setTimeout(() => {
              startBtn.innerHTML = "Game Start";
            }, 1000);
          } else {
            // ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ctx.beginPath();
            // ctx.rect(0, 0, canvas.width, canvas.height);
            // ctx.fillStyle = 'black';
            // ctx.fill();
            if (this.life == 2) {
              ctx.drawImage(x2, canvas.width / 2 - this.size, canvas.height / 2 - this.size, 100, 80);
            } else if (this.life == 1) {
              ctx.drawImage(x1, canvas.width / 2 - this.size, canvas.height / 2 - this.size, 100, 80);
            }
            // setTimeout(() => {
            //   ctx.drawImage(x2, canvas.width / 2 - this.size, canvas.height / 2 - this.size, 100, 80);
            // }, 1000);
            setTimeout(() => {
              isOver = false;
              monsterInterval = setInterval(monsterMove, 10);
              playGame = setInterval(draw, 10);
            }, 3000);
          }
        }
        if (isTrap) {
          objectList.filter((obj) => {
            if (obj.id === '함정') {
              objectList.push(new Object('피라냐식물', 5, obj.x, obj.y - 100, 100, 100));
            }
          });
          setTimeout(() => {
            objectList = objectList.filter(obj => obj.name !== "피라냐식물");
          }, 300);
          this.x = 0;
          this.y = canvas.height - this.size;
        }
        if (isCrash) {
          this.x = px;
          // this.y = py;
          this.y = canvas.height - this.size;
        }
        if (isItemBlock) {
          setTimeout(() => {
            objectList = objectList.filter(obj => obj.name !== "아이템벽돌");
            objectList.push(new Object('아이템버섯', 0, 450, 330, 35, 35));
          }, 500);
        }
        if (goNext) {
          if (stage === 1) openNewStage();
          else if (stage === 2) openNewStage2();
        }
      }


      inRect(obj, px, py) {
        if (obj.x < px && px < obj.x + obj.width && obj.y < py && py < obj.y + obj.height) {
          return true;
        } else {
          false;
        }
      }

      isGumba(enemy) {
        if (enemy.name === '굼바') {
          // if (player.x < enemy.x + enemy.width && player.x + player.size > enemy.x &&
          //   player.y === enemy.y) {
          //   return true;
          // }
          if (player.x < enemy.x + enemy.width && player.x + player.size > enemy.x &&
            player.y + player.size > enemy.y) {
            return true;
          }
        }
        if (enemy.name === '플라잉굼바') {
          if (player.x < enemy.x + enemy.width && player.x + player.size > enemy.x &&
            player.y < enemy.y + enemy.width) {
            return true;
          }
        }
      }

      밟았을때
      inBottom(obj, px, py) {
        if ((obj.x < px && px < obj.x + obj.width) &&
          (obj.y <= py && py < obj.y + 10)) {
          return true;
        }
        return false;
      }

      // 머리 부딪혔을때
      heading(obj, px, py) {
        if ((obj.x < px && px < obj.x + obj.width) &&
          (obj.y + obj.height - 25 < py && py <= obj.y + obj.width)) {
          return true;
        } else {
          return false;
        }
      }

      collision(obj) {

        if (this.inRect(obj, this.x, this.y)) {
          return true;
        }
        // player의 오른쪽 상단 모서리가 닿으면
        else if (this.inRect(obj, this.x + this.size, this.y)) {
          return true;
        }
        // player의 왼쪽 하단 모서리가 닿으면
        else if (this.inRect(obj, this.x, this.y + this.size)) {
          // isPotal = true;
          return true;
        }
        // player의 오른쪽 하단 모서리가 닿으면
        else if (this.inRect(obj, this.x + this.size, this.y + this.size)) {
          return true;
        } else return false;
      }

      render(ctx) {
        this.movePlayer();
        if (!isOver) {
          if (!마리오커짐) {
            ctx.drawImage(image, this.x, this.y, this.size, this.size);
          } else {
            ctx.drawImage(bigMario, this.x, this.y, this.size, this.size);
          }
        }
      }
    }

    class Object {
      constructor(name, id, x, y, width, height, color) {
        this.name = name;
        this.id = id; // id가 1이면 함정 파이프 !
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.color = color;
      }

      render(ctx) { // 파이프용
        ctx.beginPath();
        ctx.drawImage(파이프, this.x, this.y, this.width, this.height);
        ctx.fill();
      }

      renderBlock(ctx) { // 벽돌용
        ctx.beginPath();
        ctx.fillStyle = this.color;
        // ctx.rect(this.x, this.y, this.width, this.height);
        ctx.drawImage(벽돌, this.x, this.y, this.width, this.height);
        ctx.fill();
      }

      renderItemBlock(ctx) {
        ctx.drawImage(아이템벽돌, this.x, this.y, this.width, this.height);
      }

      renderItemMushroom(ctx) {
        ctx.drawImage(아이템버섯, this.x, this.y, this.width, this.height);
      }

      renderTrapPipe(ctx) {
        ctx.drawImage(피라냐식물, this.x, this.y, this.width, this.height);
      }

      renderGumBa(ctx) {
        ctx.drawImage(굼바, this.x, this.y, this.width, this.height);
      }
      renderFlyingGumBa(ctx) {
        ctx.drawImage(플라잉굼바, this.x, this.y, this.width, this.height);
      }
      renderOneUp(ctx) {
        ctx.drawImage(oneUp, this.x, this.y, this.width, this.height);
      }
    }

    let player = new Player();

    function add() {
      objectList.push(new Object('벽돌', 111, 100, 400, 50, 50));
      objectList.push(new Object('벽돌', 112, 145, 400, 50, 50));
      objectList.push(new Object('벽돌', 113, 350, 350, 50, 50));
      objectList.push(new Object('벽돌', 114, 395, 350, 50, 50));
      objectList.push(new Object('아이템벽돌', '아이템벽돌', 445, 350, 50, 50));
      objectList.push(new Object('굼바', 6, 200, canvas.height - 30, 30, 30));
      objectList.push(new Object('플라잉굼바', 7, 100, 200, 40, 40));
      objectList.push(new Object('파이프', '함정', canvas.width - 400, 400, 100, 200));
      objectList.push(new Object('파이프', 0, canvas.width - 100, 400, 100, 200));
      console.log(objectList);
      objectList.forEach((e) => {
        console.log(e.x);
      })

    }


    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      backX += 1;
      if (stage == 0) {
        ctx.drawImage(배경, backX, 0, canvas.width, canvas.height);
        ctx.drawImage(배경, backX - canvas.width, 0, canvas.width, canvas.height);
      } else if (stage == 1) {
        ctx.drawImage(배경2, backX, 0, canvas.width, canvas.height);
        ctx.drawImage(배경2, backX - canvas.width, 0, canvas.width, canvas.height);
      }
      if (backX == canvas.width) {
        backX = 0;
      }
      objectList.forEach((e) => {
        if (e.name == '벽돌') {
          e.renderBlock(ctx);
        } else if (e.name == '아이템벽돌') {
          e.renderItemBlock(ctx);
        } else if (e.name == '아이템버섯') {
          e.renderItemMushroom(ctx);
        } else if (e.name == '피라냐식물') {
          e.renderTrapPipe(ctx);
        } else if (e.name == '굼바') {
          e.renderGumBa(ctx);
        } else if (e.name == '플라잉굼바') {
          e.renderFlyingGumBa(ctx);
        } else if (e.name == '파이프') {
          e.render(ctx)
        } else if (e.name == 'oneUp') {
          e.renderOneUp(ctx);
        }
      })
      player.render(ctx);
    }

    let back = false;
    let flyingBack = false;
    let itemBack = false;

    function monsterMove() {
      // objectList.push(new Object('굼바', 6, 0, canvas.height - 50, 100, 100));
      // ctx.drawImage(굼바, this.x, this.y, this.width, this.height);

      objectList.filter((obj) => {
        if (obj.name === "굼바") {
          if (!back) {
            obj.x += 2;
          } else {
            obj.x -= 2;
          }
          if (obj.x == canvas.width - obj.width) {
            back = true;
          }
          if (obj.x == obj.width) {
            back = false;
          }
        } else if (obj.name === '플라잉굼바') {
          if (!flyingBack) {
            obj.x += 1.5;
          } else {
            obj.x -= 1.5;
          }

          // 위 아래로 날아다니는 굼바 구현
          setTimeout(() => {
            obj.y -= 0.5;
          }, 70);

          if (obj.y < 195) {
            setTimeout(() => {
              obj.y += 3;
            }, 60);
          }

          if (obj.x >= canvas.width - obj.width) {
            flyingBack = true;
          }
          if (obj.x == obj.width) {
            flyingBack = false;
          }
        } else if (obj.name === "아이템버섯") {
          setTimeout(() => {
            obj.y += 5;
            if (obj.y >= canvas.height - obj.height) {
              obj.y = canvas.height - obj.height;
            }
          }, 100);
          // obj.y = canvas.height - obj.height;
          if (!itemBack) {
            obj.x += 2;
          } else {
            obj.x -= 2;
          }
          if (obj.x >= 700) {
            itemBack = true;
          }
          if (obj.x <= obj.width) {
            itemBack = false;
          }
        }
      })
    }

    function openNewStage() {
      player.x = 0;
      player.y = canvas.height - player.size;
      objectList = [];
      objectList.push(new Object('벽돌', 0, canvas.width / 2, canvas.height / 2, 400, 200, 'green'));
      objectList.push(new Object('파이프', 2, canvas.width - 100, 400, 100, 150, 'pink'));
      console.log(objectList);
    }

    function openNewStage2() {
      player.x = 0;
      player.y = canvas.height - player.size;
      objectList = [];
      objectList.push(new Object('벽돌', 0, 300, canvas.height / 2, 400, 200, 'gray'));
      objectList.push(new Object('파이프', 2, canvas.width - 100, 400, 100, 150, 'pink'));
      console.log(objectList);
    }


    startBtn.addEventListener('click', gameStart);
    let monsterInterval = null;
    let playGame = null;

    function gameStart() {
      player.life = 3;
      isOver = false;
      startBtn.style.visibility = "hidden";
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      objectList = [];
      add();
      monsterInterval = setInterval(monsterMove, 10);
      playGame = setInterval(draw, 10);
    }
  </script>
</body>

</html>